
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TV Legacy Player</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      background: black;
      height: 100%;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
  </style>
</head>
<body>
  <video id="videoPlayer" autoplay muted playsinline></video>
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const supabase = createClient(
      'https://wqrkkkqmbrksleagqsli.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indxcmtra3FtYnJrc2xlYWdxc2xpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNTA1OTMsImV4cCI6MjA2NDYyNjU5M30.XNGR57FM29Zxskyzb8xeXLrBtH0cnco9yh5X8Sb4ISY'
    )

    const videoElement = document.getElementById('videoPlayer')
    videoElement.muted = true
    videoElement.volume = 1.0

    let playlist = []
    let currentIndex = 0

    const getTodayVideos = async () => {
      const today = new Date().toISOString().split('T')[0]
      const { data, error } = await supabase
        .from('videos')
        .select('*')
        .lte('start_date', today)
        .gte('end_date', today)
        .order('created_at', { ascending: true })

      if (error || !data || data.length === 0) {
        playlist = ['/tvlegacy/videos/backup/tomas_v7.mp4']
      } else {
        playlist = data.map(v => v.url)
      }

      currentIndex = 0
      playCurrent()
    }

    const playCurrent = () => {
      if (playlist.length === 0) return

      videoElement.src = playlist[currentIndex]
      videoElement.play().catch(console.error)
    }

    videoElement.addEventListener('ended', () => {
      currentIndex = (currentIndex + 1) % playlist.length
      playCurrent()
    })

    setInterval(() => {
      getTodayVideos()
    }, 1000 * 60 * 5)

    getTodayVideos()
  </script>
</body>
</html>
